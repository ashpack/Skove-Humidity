<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SKOV Humidity Offset</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <style>
    :root {
      --bg-main: #0f1218;
      --card-bg: #191d26;
      --card-border: #232838;
      --accent-blue: #0b84ff;
      --accent-blue-dark: #024a88;
      --accent-blue-light: #37a0f4;
      --text-main: #f5f7ff;
      --text-muted: #a7b0c5;
      --danger: #ff4b5c;
      --warning-bg: #fff2d6;
      --ok-bg: #e6f3ff;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 12px;
      background: radial-gradient(circle at top, #151a25 0, #05060a 55%);
      color: var(--text-main);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .app {
      max-width: 820px;
      margin: 0 auto;
    }

    .header {
      border-radius: 18px;
      padding: 14px 16px;
      margin-bottom: 12px;
      background: linear-gradient(135deg, var(--accent-blue-dark), var(--accent-blue-light));
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.45);
      color: white;
    }

    .header-title {
      font-size: 1.3rem;
      font-weight: 650;
      margin-bottom: 2px;
    }

    .header-subtitle {
      font-size: 0.85rem;
      opacity: 0.9;
    }

    .house-card {
      background: var(--card-bg);
      border-radius: 14px;
      padding: 10px 12px 12px;
      border: 1px solid var(--card-border);
      margin-bottom: 10px;
    }

    .section-heading {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .house-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
    }

    label {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 3px;
      color: var(--text-muted);
    }

    input[type="number"],
    input[type="text"] {
      width: 100%;
      padding: 8px 9px;
      border-radius: 8px;
      border: 1px solid #323647;
      background: #0d1017;
      color: var(--text-main);
      font-size: 0.95rem;
      outline: none;
      transition: border-color 0.12s ease, box-shadow 0.12s ease;
    }

    input:focus {
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 1px rgba(11, 132, 255, 0.7);
    }

    input::placeholder {
      color: #596073;
    }

    .sensors-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 10px;
      margin-top: 8px;
    }

    .sensor-card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 10px 12px 12px;
      border: 1px solid var(--card-border);
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.35);
    }

    .sensor-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .sensor-pill {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: var(--accent-blue);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 700;
      color: white;
    }

    .field-block {
      margin-bottom: 8px;
    }

    .offset-row {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 6px;
      align-items: center;
    }

    .offset-btn {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: none;
      background: #202431;
      color: var(--text-main);
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
      padding: 0;
    }

    .offset-btn:active {
      transform: scale(0.93);
      background: #30384a;
    }

    .result-box {
      margin-top: 8px;
      padding: 8px 9px;
      border-radius: 10px;
      background: var(--ok-bg);
      color: #0b1730;
      font-size: 0.87rem;
      display: none;
    }

    .result-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .result-offset {
      font-weight: 700;
      font-size: 0.95rem;
    }

    .warn {
      margin-top: 6px;
      padding-top: 4px;
      border-top: 1px dashed rgba(0, 0, 0, 0.15);
      color: var(--danger);
      white-space: pre-line;
    }

    .controls {
      margin-top: 14px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-start;
    }

    .btn {
      border-radius: 999px;
      padding: 11px 16px;
      border: none;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-primary {
      width: 100%;
      background: linear-gradient(135deg, var(--accent-blue-dark), var(--accent-blue));
      color: white;
      box-shadow: 0 10px 20px rgba(1, 60, 120, 0.6);
    }

    .btn-primary:active {
      transform: scale(0.97);
      box-shadow: 0 4px 10px rgba(1, 60, 120, 0.6);
    }

    .btn-secondary {
      width: 100%;
      background: transparent;
      border: 1px solid #3a4257;
      color: var(--text-muted);
      padding: 8px 16px;
      font-size: 0.9rem;
    }

    .btn-secondary:active {
      background: #1a1f2b;
    }

    .btn-ghost-small {
      margin-top: 2px;
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 0.78rem;
      padding: 2px 0;
      cursor: pointer;
      opacity: 0.5;
    }

    .btn-ghost-small:hover {
      opacity: 0.9;
      text-decoration: underline;
    }

    .btn-ghost-small:active {
      opacity: 1;
    }

    .error {
      margin-top: 4px;
      font-size: 0.86rem;
      color: #ffb4c2;
      min-height: 1em;
    }

    .house-summary {
      margin-top: 10px;
      padding: 8px 10px;
      border-radius: 10px;
      background: #141823;
      border: 1px dashed var(--card-border);
      font-size: 0.9rem;
      display: none;
      white-space: pre-line;
    }

    .house-summary-title {
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--text-main);
    }

    .logic-panel {
      margin-top: 10px;
      padding: 8px 10px;
      border-radius: 10px;
      background: #101320;
      border: 1px dashed #303549;
      font-size: 0.85rem;
      display: none;
      white-space: pre;
      overflow-x: auto;
      font-family: "SF Mono", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .logic-panel-title {
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--text-main);
    }

    @media (max-width: 599px) {
      .house-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .house-grid > div:last-child {
        grid-column: span 2;
      }

      .btn-primary,
      .btn-secondary {
        width: 100%;
      }
    }
  </style>
</head>

<body>
<div class="app">

  <header class="header">
    <div class="header-title">SKOV Humidity Offset</div>
    <div class="header-subtitle">
      Target actual 55% ‚Ä¢ SKOV setpoint 70% ‚Ä¢ Max offset ¬±10 ‚Ä¢ Auto setpoint suggestion
    </div>
  </header>

  <!-- HOUSE TARGET -->
  <section class="house-card">
    <div class="section-heading">House target</div>
    <div class="house-grid">
      <div>
        <label for="desired">Desired actual (% RH)</label>
        <input id="desired" type="number" value="55" step="0.1">
      </div>
      <div>
        <label for="targetDiff">Target SKOV above actual (%)</label>
        <input id="targetDiff" type="number" value="15" step="0.1">
      </div>
      <div>
        <label for="setpoint">Current SKOV setpoint (% RH)</label>
        <input id="setpoint" type="number" value="70" step="0.1">
      </div>
    </div>
  </section>

  <!-- SENSORS SIDE BY SIDE -->
  <section class="sensors-grid">

    <!-- SENSOR 1 -->
    <div class="sensor-card">
      <div class="sensor-title">
        <span class="sensor-pill">1</span> Sensor 1
      </div>

      <div class="field-block">
        <label for="fluke1">Fluke @ Sensor 1 (% RH)</label>
        <input id="fluke1" type="number" placeholder="e.g. 50.6" step="0.1">
      </div>

      <div class="field-block">
        <label for="skov1">SKOV Sensor 1 display (% RH)</label>
        <input id="skov1" type="number" placeholder="e.g. 64.1" step="0.1">
      </div>

      <div class="field-block">
        <label for="offset1">Current Sensor 1 offset</label>
        <div class="offset-row">
          <button class="offset-btn" type="button" onclick="stepOffset('offset1', -0.5)">‚àí</button>
          <input id="offset1" type="text" value="0" inputmode="decimal">
          <button class="offset-btn" type="button" onclick="stepOffset('offset1', 0.5)">+</button>
        </div>
      </div>

      <div id="result1" class="result-box">
        <div class="result-title">Sensor 1 result</div>
        <div>Set offset to: <span id="offset1New" class="result-offset"></span></div>
        <div id="offset1Warning" class="warn"></div>
      </div>
    </div>

    <!-- SENSOR 2 -->
    <div class="sensor-card">
      <div class="sensor-title">
        <span class="sensor-pill">2</span> Sensor 2
      </div>

      <div class="field-block">
        <label for="fluke2">Fluke @ Sensor 2 (% RH)</label>
        <input id="fluke2" type="number" placeholder="e.g. 50.6" step="0.1">
      </div>

      <div class="field-block">
        <label for="skov2">SKOV Sensor 2 display (% RH)</label>
        <input id="skov2" type="number" placeholder="e.g. 64.1" step="0.1">
      </div>

      <div class="field-block">
        <label for="offset2">Current Sensor 2 offset</label>
        <div class="offset-row">
          <button class="offset-btn" type="button" onclick="stepOffset('offset2', -0.5)">‚àí</button>
          <input id="offset2" type="text" value="0" inputmode="decimal">
          <button class="offset-btn" type="button" onclick="stepOffset('offset2', 0.5)">+</button>
        </div>
      </div>

      <div id="result2" class="result-box">
        <div class="result-title">Sensor 2 result</div>
        <div>Set offset to: <span id="offset2New" class="result-offset"></span></div>
        <div id="offset2Warning" class="warn"></div>
      </div>
    </div>

  </section>

  <!-- CONTROLS -->
  <section class="controls">
    <button class="btn btn-primary" type="button" onclick="calculate()">Calculate</button>
    <button class="btn btn-secondary" type="button" onclick="clearForm()">Clear form</button>
    <button class="btn-ghost-small" type="button" onclick="requestLogic()">
      üîç Show calculation breakdown
    </button>
    <div id="globalError" class="error"></div>
  </section>

  <!-- HOUSE SUMMARY -->
  <section class="house-summary" id="houseSummary">
    <div class="house-summary-title">House setpoint suggestion</div>
    <div id="houseSummaryText"></div>
  </section>

  <!-- LOGIC BREAKDOWN -->
  <section class="logic-panel" id="logicSection">
    <div class="logic-panel-title">Calculation breakdown</div>
    <div id="logicText"></div>
  </section>

</div>

<script>
  let lastLogic = "";

  function toNum(v, def = 0) {
    if (v === null || v === undefined) return def;
    v = String(v).replace(",", ".").trim();
    const n = parseFloat(v);
    return isNaN(n) ? def : n;
  }

  function stepOffset(id, delta) {
    const input = document.getElementById(id);
    const current = toNum(input.value, 0);
    let next = current + delta;
    if (next > 10) next = 10;
    if (next < -10) next = -10;
    input.value = next.toFixed(1);
  }

  function calculateSensor(fluke, skov, offset, setpoint, diff) {
    const idealSkov = fluke + diff;       // Fluke + targetDiff
    const offsetNeeded = idealSkov - skov;
    const newOffsetRaw = offset + offsetNeeded;

    const max = 10;
    let newOffset = newOffsetRaw;
    let clipped = false;

    if (newOffset > max) { newOffset = max; clipped = true; }
    if (newOffset < -max) { newOffset = -max; clipped = true; }

    const remaining = newOffsetRaw - newOffset; // leftover after hitting limit
    const newSetpoint = clipped ? setpoint + remaining : null;

    return { newOffset, clipped, remaining, newSetpoint, idealSkov, offsetNeeded, newOffsetRaw };
  }

  // Handle one sensor UI + return result for house summary and logic
  function handleSensor(index, flukeId, skovId, offsetId, sensorName, diff, setpoint) {
    const flukeStr = document.getElementById(flukeId).value.trim();
    const skovStr  = document.getElementById(skovId).value.trim();

    const resultId     = index === 1 ? "result1" : "result2";
    const offsetSpanId = index === 1 ? "offset1New" : "offset2New";
    const warningId    = index === 1 ? "offset1Warning" : "offset2Warning";

    const resultBox = document.getElementById(resultId);
    const offsetSpan = document.getElementById(offsetSpanId);
    const warnEl = document.getElementById(warningId);

    // If both empty: hide and skip
    if (!flukeStr && !skovStr) {
      resultBox.style.display = "none";
      warnEl.textContent = "";
      return null;
    }

    // If one missing: hide and skip
    if (!flukeStr || !skovStr) {
      resultBox.style.display = "none";
      warnEl.textContent = "";
      return null;
    }

    const fluke  = toNum(flukeStr, NaN);
    const skov   = toNum(skovStr, NaN);
    const offset = toNum(document.getElementById(offsetId).value, 0);

    if (isNaN(fluke) || isNaN(skov)) {
      resultBox.style.display = "none";
      warnEl.textContent = "";
      return null;
    }

    const res = calculateSensor(fluke, skov, offset, setpoint, diff);

    offsetSpan.textContent =
      (res.newOffset >= 0 ? "+" : "") + res.newOffset.toFixed(1) + "%";

    if (res.clipped) {
      // Offset limit reached, but house setpoint suggestion will be shown globally
      warnEl.textContent =
        `Offset limit reached for ${sensorName}.\n` +
        `Any additional adjustment will be handled in the house setpoint suggestion below.`;
    } else {
      warnEl.textContent = "";
    }

    resultBox.style.display = "block";

    // Return full info for logic breakdown
    return {
      fluke,
      skov,
      offset,
      sensorName,
      ...res
    };
  }

  function calculate() {
    const desired  = toNum(document.getElementById("desired").value, NaN);
    const diff     = toNum(document.getElementById("targetDiff").value, NaN);
    const setpoint = toNum(document.getElementById("setpoint").value, NaN);
    const globalError = document.getElementById("globalError");
    const houseSummaryBox = document.getElementById("houseSummary");
    const houseSummaryText = document.getElementById("houseSummaryText");
    const logicSection = document.getElementById("logicSection");
    const logicText = document.getElementById("logicText");

    globalError.textContent = "";
    houseSummaryBox.style.display = "none";
    houseSummaryText.textContent = "";
    logicSection.style.display = "none";
    logicText.textContent = "";
    lastLogic = "";

    if (isNaN(desired) || isNaN(diff) || isNaN(setpoint)) {
      globalError.textContent = "Check house target values (e.g. 55 / 15 / 70).";
      return;
    }

    const r1 = handleSensor(1, "fluke1", "skov1", "offset1", "Sensor 1", diff, setpoint);
    const r2 = handleSensor(2, "fluke2", "skov2", "offset2", "Sensor 2", diff, setpoint);

    // Build combined house setpoint suggestion based on sensors that hit the offset limit
    const remainingList = [];
    let avgRemaining = null;
    let newSet = null;
    let direction = null;

    [r1, r2].forEach(res => {
      if (res && res.clipped && Math.abs(res.remaining) > 0.0001) {
        remainingList.push(res.remaining);
      }
    });

    if (remainingList.length > 0) {
      const totalRemaining = remainingList.reduce((a, b) => a + b, 0);
      avgRemaining = totalRemaining / remainingList.length;
      newSet = setpoint + avgRemaining;
      direction = avgRemaining > 0 ? "increase" : "decrease";

      houseSummaryText.textContent =
        `Sensors indicate the house setpoint should be ${direction}d ` +
        `from ${setpoint.toFixed(1)}% to about ${newSet.toFixed(1)}%.\n\n` +
        `Before adjusting the setpoint, check for:\n` +
        `‚Ä¢ Faulty Sensor\n` +
        `‚Ä¢ Spray cooling not spraying evenly across the house\n` +
        `‚Ä¢ Check cooling pads for any issues\n\n` +
        `‚ö†Ô∏è Manager permission required before changing the setpoint.`;

      houseSummaryBox.style.display = "block";
    }

    // Build logic breakdown text
    const lines = [];

    if (r1 || r2) {
      if (r1) {
        lines.push("Sensor 1:");
        lines.push(`  Fluke: ${r1.fluke.toFixed(1)} %`);
        lines.push(`  SKOV: ${r1.skov.toFixed(1)} %`);
        lines.push(`  TargetDiff: ${diff.toFixed(1)} %`);
        lines.push(`  Ideal SKOV (Fluke + TargetDiff): ${r1.idealSkov.toFixed(1)} %`);
        lines.push(`  Current offset: ${r1.offset.toFixed(1)} %`);
        lines.push(`  Offset needed (Ideal - SKOV): ${r1.offsetNeeded.toFixed(1)} %`);
        lines.push(`  Raw new offset (current + needed): ${r1.newOffsetRaw.toFixed(1)} %`);
        lines.push(`  New offset after ¬±10 limit: ${r1.newOffset.toFixed(1)} %`);
        lines.push(`  Clipped at limit: ${r1.clipped ? "YES" : "NO"}`);
        lines.push(`  Remaining after limit (raw - new): ${r1.remaining.toFixed(1)} %`);
        lines.push("");
      } else {
        lines.push("Sensor 1: no valid data entered.");
        lines.push("");
      }

      if (r2) {
        lines.push("Sensor 2:");
        lines.push(`  Fluke: ${r2.fluke.toFixed(1)} %`);
        lines.push(`  SKOV: ${r2.skov.toFixed(1)} %`);
        lines.push(`  TargetDiff: ${diff.toFixed(1)} %`);
        lines.push(`  Ideal SKOV (Fluke + TargetDiff): ${r2.idealSkov.toFixed(1)} %`);
        lines.push(`  Current offset: ${r2.offset.toFixed(1)} %`);
        lines.push(`  Offset needed (Ideal - SKOV): ${r2.offsetNeeded.toFixed(1)} %`);
        lines.push(`  Raw new offset (current + needed): ${r2.newOffsetRaw.toFixed(1)} %`);
        lines.push(`  New offset after ¬±10 limit: ${r2.newOffset.toFixed(1)} %`);
        lines.push(`  Clipped at limit: ${r2.clipped ? "YES" : "NO"}`);
        lines.push(`  Remaining after limit (raw - new): ${r2.remaining.toFixed(1)} %`);
        lines.push("");
      } else {
        lines.push("Sensor 2: no valid data entered.");
        lines.push("");
      }

      if (remainingList.length > 0 && avgRemaining !== null && newSet !== null) {
        lines.push("House summary:");
        lines.push(`  Current setpoint: ${setpoint.toFixed(1)} %`);
        lines.push(`  Number of sensors at offset limit: ${remainingList.length}`);
        lines.push(
          `  Average remaining adjustment from limited sensors: ${avgRemaining.toFixed(1)} %`
        );
        lines.push(
          `  Suggested new setpoint: ${setpoint.toFixed(1)} % -> ${newSet.toFixed(1)} % (${direction}d)`
        );
      } else {
        lines.push("House summary:");
        lines.push("  No sensors hit the ¬±10 offset limit.");
        lines.push("  No setpoint change suggested by calculator.");
      }
    } else {
      lines.push("No valid sensor data entered ‚Äì nothing to calculate.");
    }

    lastLogic = lines.join("\n");
  }

  function requestLogic() {
    if (!lastLogic) {
      alert("Run a calculation first.");
      return;
    }

    const logicSection = document.getElementById("logicSection");
    const logicText = document.getElementById("logicText");

    logicText.textContent = lastLogic;
    logicSection.style.display = "block";
    logicSection.scrollIntoView({ behavior: "smooth", block: "start" });
  }

  function clearForm() {
    document.getElementById("desired").value = 55;
    document.getElementById("targetDiff").value = 15;
    document.getElementById("setpoint").value = 70;

    ["fluke1","skov1","fluke2","skov2"].forEach(id => {
      document.getElementById(id).value = "";
    });

    document.getElementById("offset1").value = "0";
    document.getElementById("offset2").value = "0";

    document.getElementById("result1").style.display = "none";
    document.getElementById("result2").style.display = "none";
    document.getElementById("offset1Warning").textContent = "";
    document.getElementById("offset2Warning").textContent = "";
    document.getElementById("globalError").textContent = "";

    const houseSummaryBox = document.getElementById("houseSummary");
    const houseSummaryText = document.getElementById("houseSummaryText");
    houseSummaryBox.style.display = "none";
    houseSummaryText.textContent = "";

    const logicSection = document.getElementById("logicSection");
    const logicText = document.getElementById("logicText");
    logicSection.style.display = "none";
    logicText.textContent = "";
    lastLogic = "";
  }
</script>

</body>
</html>
